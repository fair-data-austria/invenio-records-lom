{# -*- coding: utf-8 -*-

  Copyright (C) 2021 Graz University of Technology.

  invenio-records-lom is free software; you can redistribute it and/or modify it
  under the terms of the MIT License; see LICENSE file for more details.
#}

{%- extends "invenio_app_rdm/records/detail.html" %}

{% from "invenio_records_lom/records/macros/files.html" import lom_file_list_box, lom_preview_file_box %}

{% block head_title %}
<title>{{ record.metadata.general.title.string }}</title>
{% endblock head_title %}

{% block record_header %}
{% block record_header_button %}
{{ super() }}
{% endblock record_header_button %}
<div class="ui grid middle aligned">
  <div class="two column row">
    <div class="right floated right aligned column">
      {% if record.ui.resource_type %}
      <span class="ui label small grey"> {{ record.ui.resource_type | capitalize }}</span>
      {% endif %}
      <span class="ui label small access-status {{ record.ui.access_status.id }}" data-tooltip="{{ record.ui.access_status.description_l10n }}" data-inverted="">
        {% if record.ui.access_status.icon %}<i class="icon {{ record.ui.access_status.icon }}"></i>{% endif %}
        {{ record.ui.access_status.title_l10n }}
      </span>
    </div>
  </div>
</div>
{% endblock record_header %}


{% block record_title %}
<h1>{{ metadata.general.title.string | title }}</h1>
{% endblock record_title %}


{%- macro make_dep_tree(relations, kind, rel_msg) -%}
{% for relation in relations | selectattr("kind.value", "equalto", kind) -%}
{% for identifier in relation.resource.identifier | selectattr("catalog", "equalto", "repo-pid") -%}
<li>
  <a class="ui tooltip-popup text-muted" href="{{identifier.entry}}">
    {{ rel_msg }} {{ identifier.resource_type }}: {{ identifier.metadata.general.title.string | title }}
  </a>
</li>
<ul>
  {{ make_dep_tree(identifier.metadata.relation, kind, rel_msg) }}
</ul>
{% endfor -%}
{% endfor -%}
{%- endmacro %}


{% block record_content %}
{%- for role, contributions in metadata.lifeCycle.contribute | selectattr("role.value") | groupby("role.value") | sort(attribute=0) %}
<p>
  <h4><b>{{role | capitalize}}(s)</b></h4>
  {%- for entities in contributions | map(attribute="entity") %}
  {%- for entity in entities %}
  <span class="ui tooltip-popup text-muted">
    {{entity}}
  </span>
  {{"; " if not loop.last}}
  {%- endfor %}
  {{"; " if not loop.last}}
  {%- endfor %}
</p>
{%- endfor %}
<hr class="thin-line">
{{ metadata.general.description.0.string | safe }}
<hr class="thin-line">

<ul class="ui list">
{{ make_dep_tree(metadata.relation, "ispartof", "Part of the") }}
</ul>
<ul class="ui list">
{{ make_dep_tree(metadata.relation, "haspart", "Contains") }}
</ul>
{% endblock record_content %}


{% block record_files %}
  {%- if record.files.enabled -%}
    {%- if permissions.can_read_files -%}
      {# record has files AND user can see files #}
      {%- set files = files|order_entries %}
      {%- if files|has_previewable_files -%}
        {%-set preview_file = files|select_preview_file(default_preview=record.files.default_preview) %}
        {{ lom_preview_file_box(preview_file, pid, is_preview, record) }}
      {%- endif -%}
      {{ lom_file_list_box(files, pid, is_preview, record) }}
    {% else %}
      {# record has files BUT user cannot see files #}
      <div class="panel-spacing">
        <div class="ui accordion panel {{ record.ui.access_status.id }}" id="preview" href="#collapsablePreview">
          <div class="active title panel-heading {{ record.ui.access_status.id }}">
            {{ _("Files") }}
            <i class="angle down icon"></i>
          </div>
          <div id="collapsablePreview" class="active content">
            <div class="ui {{ record.ui.access_status.message_class }} message file-box-message">
              <i class="ui {{ record.ui.access_status.icon }} icon"></i><b>{{ record.ui.access_status.title_l10n }}</b>
              <p>{{ record.ui.access_status.description_l10n }}</p>
              {% if record.access.embargo.reason %}
                <p>{{_("Reason")}}: {{record.access.embargo.reason}}</p>
              {% endif%}
            </div>
          </div>
        </div>
      </div>
    {%- endif %}
  {%- endif %}
{% endblock record_files %}


{% block record_details %}
{% endblock record_details %}


{% block record_sidebar %}
{%- if config.get("LOM_RECORD_EXPORTERS") -%}
{# if no export formats are specified, don't bother showing the box #}
<div class="ui segment rdm-sidebar exports">
  <dt><b>{{ _('Export')}}</b></dt>
  <hr class="thin-line">
  <dd class="top-bottom-padded">
    <div class="ui celled horizontal list separated-list">
      {# dynamically create the list of export formats #}
      {%- for fmt, val in config.get("LOM_RECORD_EXPORTERS", {}).items() -%}
        {%- set name = val.get("name", fmt) -%}
        {% if is_preview %}
          {%- set export_url = url_for('invenio_records_lom.record_export', pid_value=record.id, export_format=fmt, preview=1) -%}
        {% else %}
          {%- set export_url = url_for('invenio_records_lom.record_export', pid_value=record.id, export_format=fmt) -%}
        {% endif %}
         <div class="item"><a href="{{ export_url }}">{{ name }}</a></div>
      {%- endfor -%}
    </div>
  </dd>
</div>
{%- endif -%}
{% endblock record_sidebar %}
